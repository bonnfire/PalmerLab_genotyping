## SAMPLE BARCODE LIBRARY 
# TABLE GENERATED BY KHAI/HANNAH 
# INFO IN THIS TABLE IS USED FOR DEMULTIPLEXING 

# columns should include RFID, project_name, barcode, library, and notes 


################################# 
## SAMPLE BARCODE LIBRARY TABLE 
################################# 

# get rid of the Riptide filter to see the UMich data
setwd("~/Dropbox (Palmer Lab)/Palmer Lab/Bonnie Lin/U01/20190829_WFU_U01_ShippingMaster/Tissues/Original")
flowcell_files <- list.files(path = ".", pattern = "^\\d{4}-\\d{2}-\\d{2}-Flowcell Sample-Barcode list.*[^)].xlsx")

u01.importxlsx <- function(xlname){
  path_sheetnames <- readxl::excel_sheets(xlname)
  df <- lapply(readxl::excel_sheets(path = xlname), readxl::read_excel, path = xlname)
  names(df) <- path_sheetnames
  return(df)
} 

flowcell <- lapply(flowcell_files, function(x){
  x <- u01.importxlsx(x)[[1]] %>% 
    clean_names() 
  return(x)
})
names(flowcell) <- flowcell_files 

flowcell_df <- flowcell %>% rbindlist(idcol = "filename", fill = T, use.names = T) %>% 
  mutate(comment = coalesce(comments_8, comments_9)) %>% 
  select(-c("x7", "comments_8", "comments_9", "flow_cell_lane")) %>%  # columns that only contain NA or have been coalesced
  # dplyr::filter(grepl("Riptide", library)) %>% 
  mutate(comment = toupper(comment)) %>% 
  mutate(rfid = ifelse(grepl("^\\d{9}$", sample_id),
                       paste0("933000", sample_id), sample_id_demul))  # create a column for rfid if it doesn't already exist

flowcell_df %>% mutate_at(vars(one_of("library")), as.factor) %>% summary()
flowcell_df %>% subset(!is.na(sample_id_demul)) %>% get_dupes(sample_id_demul)

# check for dupes
flowcell_df %>% get_dupes(rfid)

# fix dupes and flag column
flowcell_df <- flowcell_df %>%
  mutate(flag = NA) %>% 
  mutate(comment = ifelse(rfid == "933000120138361"&library=="Riptide-01", "Real correct 933000120138361 is in Riptide06", comment), # dupe ID fixed 07/23/2020
         flag = ifelse(rfid == "933000120138361"&library=="Riptide-01", "Suspect RFID", flag),
         rfid = replace(rfid, rfid == "933000120138361"&library=="Riptide-01", "933000120138561"))

# post fix check for dupes 
flowcell_df %>% get_dupes(rfid)

## assign project_name 
flowcell_df_fordb <- flowcell_df %>% 
  mutate(rfid = coalesce(rfid, sample_id)) %>% 
  left_join(sample_metadata[, c("rfid", "project_name")], by ="rfid") %>% 
  mutate(library = gsub("Riptide-", "Riptide", library)) 

## fix no project_name 
flowcell_df_fordb %>% subset(is.na(project_name)) %>% select(rfid, library, project_name)


flowcell_df_fordb <- flowcell_df_fordb %>% 
  mutate(comment = ifelse(rfid == "933000120157342"&library=="Riptide01", "Original RFID was 933000120157342", comment),
         flag = ifelse(rfid == "933000120157342"&library=="Riptide01", "Suspect RFID", flag),
         rfid = replace(rfid, rfid == "933000120157342"&library=="Riptide01", "933000120117342"),
         
         comment = ifelse(rfid == "933000520138331"&library=="Riptide01", "Original RFID was 933000520138331", comment),
         flag = ifelse(rfid == "933000520138331"&library=="Riptide01", "Suspect RFID", flag),
         rfid = replace(rfid, rfid == "933000520138331"&library=="Riptide01", "933000120138331"),
         
         comment = ifelse(rfid == "933000320046825"&library=="Riptide06", "Original RFID was 933000320046825", comment),
         flag = ifelse(rfid == "933000320046825"&library=="Riptide06", "Suspect RFID", flag),
         rfid = replace(rfid, rfid == "933000320046825"&library=="Riptide06", "933000320045825")) %>%
  rowwise() %>% 
  mutate(rfid = replace(rfid, grepl("\\d+_Plate\\d+_", rfid), gsub("_", "", rfid))) %>% # fix the format of the zebrafish names 
  ungroup() %>% 
  left_join(sample_metadata[, c("rfid", "project_name")], by ="rfid") %>% 
  mutate(project_name = coalesce(project_name.y, project_name.x)) %>% 
  select(-matches("project_name[.][xy]")) 

# %>%
  # subset(!is.na(project_name)) ## XX TEMPORARY excludes the pilot fish
  

  

  
## CREATE SAMPLE BARCODE LIBRARY TABLE
sample_barcode_lib <- flowcell_df_fordb %>% 
  rename("comments" = "comment") %>% 
  select(rfid, project_name, barcode, library, comments, flag) 
  

write.csv(sample_barcode_lib, file = "sample_barcode_lib.csv", row.names = F)



## 
flowcell_df %>% 
  mutate(rfid = coalesce(rfid, sample_id)) %>% 
  left_join(sample_metadata[, c("rfid", "project_name")], by ="rfid") %>% 
  mutate(library = gsub("Riptide-", "Riptide", library)) %>% subset(is.na(project_name)&library=='UMich8_Fish') %>% 
  rename("comments" = "comment") %>% 
  mutate(comments = "Test samples with high missing rate, exclude from imputation, no phenotypes") %>% 
  select(rfid, project_name, barcode, library, comments, flag) %>% 
  write.csv(file = "no_phenotype_fish_sample_barcode_lib.csv", row.names = F)




## upload the pgdump file into the db

con <- dbConnect(dbDriver("PostgreSQL"), dbname="PalmerLab_Datasets",user="postgres",password="postgres")
dbWriteTable(con, c("sample_tracking","sample_barcode_library"), value = sample_barcode_lib, row.names = FALSE)

dbExecute(con,"ALTER TABLE sample_tracking.sample_barcode_library RENAME COLUMN \"sample_id_demul\" TO \"rfid\"")
dbExecute(con,"ALTER TABLE sample_tracking.sample_barcode_library ADD PRIMARY KEY(rfid,project_name)")
  
dbExecute(con, "sp_columns sample_tracking.sample_barcode_library")
dbExecute(con, "SELECT COLUMN_NAME FROM sample_tracking.sample_barcode_library")


## use dbSendQuery and dbFetch to see results
# example
# see column names
# dbSendQuery(con, "SELECT column_name FROM information_schema.columns where table_schema = 'sample_tracking' and table_name = 'sample_barcode_library'") %>% dbFetch

# use this to fix close resultSet before continuing error msg 
## dbClearResult(dbListResults(con)[[1]]) 

## create the sample sheet for Riyan
# setwd("~/Dropbox (Palmer Lab)/Palmer Lab/Bonnie Lin/U01/20190829_WFU_U01_ShippingMaster/Tissues/Processed")
# 
# flow_cell_original_riyan <- u01.importxlsx("2020-01-16-Flowcell Sample-Barcode list-Riptide-UMich2-Riptide03_NovaSeq01 (copy for Riyan).xlsx") # 1 table
# dataframe = list()
# for(i in 1:10){
#   dataframe[[i]] <- flow_cell_original_riyan$Sheet1 %>% group_by(Barcode) %>% slice(i)
# }
# write.xlsx(dataframe, file='Flowcell_Sample_Sheet.xlsx')

## Sending data to Graham 07/22/2020
setwd("~/Dropbox (Palmer Lab)/Palmer Lab/Bonnie Lin/U01/20190829_WFU_U01_ShippingMaster/Tissues/Processed")
genotype <- list()
genotype[[1]] <- read.csv("2020-01-16-Flowcell Sample-Barcode list-Riptide-UMich2-Riptide03_NovaSeq01 (copy for Riyan).csv") %>% clean_names %>% mutate_all(as.character)
genotype[[2]] <- read.csv("SampleSheet.csv") %>% clean_names %>% mutate_all(as.character) %>% rename("barcode" = "sample_barcode", "library" = "library_id")

genotype_df <- genotype %>% rbindlist(fill = T)
# for hs rats, riyan is using [sample_id]-[sample_name] as the unique combination
genotype_df <- genotype_df %>% mutate(genotype_id = paste0(sample_id, "-", sample_name),
                                      genotype_id = gsub(" ", "", genotype_id))





## rewrite this using rdrop2 
install.packages("httpuv")
install.packages('rdrop2')
library(rdrop2)
token <- drop_auth()
saveRDS(token, file = "token.rds") #save the tokens for local/remote use; Then in any drop_* function, pass `dtoken = token


drop_search(query = "Flowcell", path = "https://www.dropbox.com/work/Palmer%20Lab/Khai-Minh%20Nguyen/Sequencing%20Submission%20Files")







#### SENT TO SEQUENCING CORE
## 06/09/2020
## XX fix project names before uploading the sheets in the database



extractions_flowcell <- extractions_khai_df %>% 
  subset(`sampleid_barcode` %in% flow_cell_original_rip$`Sample ID`) # 288

## create this table for rsm
text(barplot(table(extractions_flowcell$u01), beside = T), 0, table(extractions_flowcell$u01))
table(extractions_flowcell$u01, extractions_flowcell$userid)

# using origin will get you the wrong cohorts?

extractions_flowcell$u01 %>% table() 
extractions_flowcell$u01_rfid_verified %>% table() 

# extractions_flowcell$origin %>% table()

olivier_spleen_list_df %>% subset(rfid %in% extractions_flowcell[which(extractions_flowcell$comments == "mismatch"),]$transponder)
extractions_flowcell[which(extractions_flowcell$comments == "mismatch"),]
extractions_flowcell %>% subset(comments == "mismatch")
# searching for duplicate entries in the sampleid barcode column FALSE FOR BOTH extractions_flowcell %>% select(transponder AND sampleid_barcode) %>% duplicated() %>% any() 
agrep("933000120117342", extractions_flowcell$transponder, value = T)
"933000120138331"
"933000120138561"

